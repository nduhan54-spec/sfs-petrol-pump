(function(){
const root = document.getElementById('root');
const APP_NAME='SFS Petrol Pump';
const CREDENTIALS={username:'sfs2021',password:'sfs2025'};
const PREFIX='sfs_pprm_';
const LOGO='/assets/icons/icon-192.png';

let state={date:new Date().toISOString().slice(0,10),petrol:Array.from({length:4},()=>({open:'',close:''})),diesel:Array.from({length:8},()=>({open:'',close:''})),sales:[],loggedIn:false};

function loadForDate(d){const p=localStorage.getItem(PREFIX+'petrol_'+d);const di=localStorage.getItem(PREFIX+'diesel_'+d);const s=localStorage.getItem(PREFIX+'sales_'+d);if(p)state.petrol=JSON.parse(p);if(di)state.diesel=JSON.parse(di);if(s)state.sales=JSON.parse(s);}
const savedUser=localStorage.getItem(PREFIX+'user'); if(savedUser){state.loggedIn=true;loadForDate(state.date);}

function el(tag,attrs,children){const e=document.createElement(tag);attrs=attrs||{};Object.entries(attrs).forEach(([k,v])=>{if(k==='class')e.className=v;else if(k==='html')e.innerHTML=v;else e.setAttribute(k,v)}); (Array.isArray(children)?children:[children]).forEach(c=>{if(!c) return; if(typeof c==='string') e.appendChild(document.createTextNode(c)); else e.appendChild(c)}); return e;}
function calcLitres(arr){return arr.reduce((s,m)=>{const o=parseFloat(m.open)||0;const c=parseFloat(m.close)||0;return s+Math.max(0,c-o)},0);}
function saveDay(){localStorage.setItem(PREFIX+'petrol_'+state.date,JSON.stringify(state.petrol));localStorage.setItem(PREFIX+'diesel_'+state.date,JSON.stringify(state.diesel));localStorage.setItem(PREFIX+'sales_'+state.date,JSON.stringify(state.sales));localStorage.setItem(PREFIX+'last_date',state.date);alert('Saved locally');}

async function generatePDF(){const date=state.date;const filename=`SFS_Petrol_Pump_Report_${date}.pdf`; const report=el('div',{class:'card'}); const headerRow=el('div',{style:'display:flex;align-items:center;gap:8px'}); const logoImg=el('img',{src:LOGO,width:48,height:48}); headerRow.appendChild(logoImg); headerRow.appendChild(el('div',{},[el('h2',{},[APP_NAME]),el('div',{},['Date: '+date])])); report.appendChild(headerRow); report.appendChild(el('hr')); report.appendChild(el('div',{},['Petrol total (meters): '+calcLitres(state.petrol).toFixed(2)+' litres'])); report.appendChild(el('div',{},['Diesel total (meters): '+calcLitres(state.diesel).toFixed(2)+' litres'])); report.appendChild(el('div',{},['Total sales amount: '+state.sales.reduce((a,b)=>a+(b.amount||0),0).toFixed(2)])); report.appendChild(el('h4',{},['Sales Breakdown'])); const table=el('table',{class:'table'}); const thead=el('thead'); thead.appendChild(el('tr',{},[el('th',{},['Vehicle']),el('th',{},['Name']),el('th',{},['Type']),el('th',{},['Litres']),el('th',{},['Rate']),el('th',{},['Amount'])])); table.appendChild(thead); const tbody=el('tbody'); state.sales.forEach(s=>tbody.appendChild(el('tr',{},[el('td',{},[s.vehicle]),el('td',{},[s.name||'']),el('td',{},[s.type]),el('td',{},[String(s.litres)]),el('td',{},[String(s.rate)]),el('td',{},[String(s.amount)])]))); table.appendChild(tbody); report.appendChild(table); const petrolTotal=calcLitres(state.petrol); const dieselTotal=calcLitres(state.diesel); const amountTotal=state.sales.reduce((a,b)=>a+(b.amount||0),0).toFixed(2); report.appendChild(el('h4',{},['Daily Summary'])); const summ=el('table',{class:'table'}); summ.appendChild(el('thead',{},[el('tr',{},[el('th',{},['Fuel Type']),el('th',{},['Total Litres']),el('th',{},['Total Amount'])])])); const sbody=el('tbody'); sbody.appendChild(el('tr',{},[el('td',{},['Petrol']),el('td',{},[petrolTotal.toFixed(2)]),el('td',{},['-'])])); sbody.appendChild(el('tr',{},[el('td',{},['Diesel']),el('td',{},[dieselTotal.toFixed(2)]),el('td',{},['-'])])); sbody.appendChild(el('tr',{},[el('td',{},['Total']),el('td',{},['-']),el('td',{},[amountTotal])])); summ.appendChild(sbody); report.appendChild(summ); const now=new Date(); report.appendChild(el('div',{class:'small'},['Report generated on: '+now.toLocaleString()])); document.body.appendChild(report); try{ if(window.html2canvas && window.jspdf){ const canvas=await window.html2canvas(report,{scale:2}); const img=canvas.toDataURL('image/png'); const pdf=new window.jspdf.jsPDF({unit:'px',format:[canvas.width,canvas.height],orientation:'portrait'}); pdf.addImage(img,'PNG',0,0,canvas.width,canvas.height); pdf.save(filename);} else { let csv='Vehicle,Name,Type,Litres,Rate,Amount\n'; state.sales.forEach(s=> csv += `${s.vehicle},${s.name||''},${s.type},${s.litres},${s.rate},${s.amount}\n`); const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename.replace('.pdf','.csv'); a.click(); } }catch(e){alert('Export failed: '+e.message);} report.remove();}

function exportBackup(){const backup={date:state.date,petrol:state.petrol,diesel:state.diesel,sales:state.sales}; const blob=new Blob([JSON.stringify(backup,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`sfs_backup_${state.date}.json`; a.click();}
function importBackup(file){const reader=new FileReader(); reader.onload=function(e){ try{ const data=JSON.parse(e.target.result); if(data.petrol) state.petrol=data.petrol; if(data.diesel) state.diesel=data.diesel; if(data.sales) state.sales=data.sales; saveDay(); alert('Backup restored'); }catch(err){alert('Invalid backup file');}}; reader.readAsText(file);}

function renderLogin(){root.innerHTML=''; const header=el('div',{class:'header'},[el('div',{class:'logo-box'},['SFS']),el('div',{},[APP_NAME])]); const container=el('div',{class:'container center'},[ el('div',{class:'card'},[ el('h2',{},['Welcome to SFS Petrol Pump']), el('div',{},['Enter credentials to continue']), el('div',{style:'height:12px'}), el('input',{class:'input',id:'username',placeholder:'Username'}), el('div',{style:'height:8px'}), el('input',{class:'input',id:'password',placeholder:'Password',type:'password'}), el('div',{style:'height:10px'}), el('div',{style:'display:flex;gap:8px'},[ el('button',{class:'button',id:'loginBtn'},['Login']), el('button',{class:'button',id:'demoBtn'},['Show Credentials']) ]) ]) ]); root.appendChild(header); root.appendChild(container); document.getElementById('loginBtn').addEventListener('click',()=>{ const u=document.getElementById('username').value.trim(); const p=document.getElementById('password').value.trim(); if(u===CREDENTIALS.username && p===CREDENTIALS.password){ localStorage.setItem(PREFIX+'user',u); state.loggedIn=true; loadForDate(state.date); renderMainMenu(); } else alert('Incorrect username or password'); }); document.getElementById('demoBtn').addEventListener('click',()=>alert('Username: '+CREDENTIALS.username+'\nPassword: '+CREDENTIALS.password));}

function renderMainMenu(){root.innerHTML=''; const header=el('div',{class:'header'},[el('div',{class:'logo-box'},['SFS']),el('div',{},[APP_NAME]),el('div',{},['Date: '+state.date]),el('button',{class:'button',id:'logoutBtn'},['Logout'])]); const container=el('div',{class:'container'},[ el('div',{class:'card'},[ el('h2',{},['Main Menu']), el('div',{class:'menu-buttons'},[ el('button',{class:'button',id:'meterBtn'},['Meter Entry']), el('button',{class:'button',id:'salesBtn'},['Sales Entry']), el('button',{class:'button',id:'recordsBtn'},['Records / Reports']), el('button',{class:'button',id:'exportBtn'},['Export PDF']), el('div',{style:'height:8px'}), el('button',{class:'button',id:'backupBtn'},['Backup Data']), el('div',{},[ el('input',{type:'file',id:'importFile', style:'display:none'}), el('button',{class:'button',id:'importBtn'},['Restore Backup']) ]) ]) ]) ]); root.appendChild(header); root.appendChild(container); document.getElementById('meterBtn').addEventListener('click',renderMeterEntry); document.getElementById('salesBtn').addEventListener('click',renderSalesEntry); document.getElementById('recordsBtn').addEventListener('click',renderRecords); document.getElementById('exportBtn').addEventListener('click',generatePDF); document.getElementById('backupBtn').addEventListener('click',exportBackup); document.getElementById('importBtn').addEventListener('click',()=>document.getElementById('importFile').click()); document.getElementById('importFile').addEventListener('change',(e)=>importBackup(e.target.files[0])); document.getElementById('logoutBtn').addEventListener('click',()=>{localStorage.removeItem(PREFIX+'user');state.loggedIn=false;renderLogin();});}

function renderMeterEntry(){root.innerHTML=''; const header=el('div',{class:'header'},[el('div',{class:'logo-box'},['SFS']),el('div',{},[APP_NAME]),el('div',{},['Date: '+state.date]),el('button',{class:'button',id:'backBtn'},['Back'])]); const container=el('div',{class:'container'},[ el('div',{class:'card'},[ el('h3',{},['Meter Entry']), el('div',{},['Date: ', el('input',{type:'date',id:'dateInput', value: state.date})]), el('h4',{},['Petrol (4 meters)']), ...state.petrol.map((m,i)=>el('div',{class:'row'},[el('div',{},['Meter '+(i+1)]),el('input',{class:'input',id:'p_open_'+i,placeholder:'Opening',value:m.open}),el('input',{class:'input',id:'p_close_'+i,placeholder:'Closing',value:m.close}),el('div',{},['Sold: '+(((parseFloat(m.close)||0)-(parseFloat(m.open)||0)).toFixed(2))]) )), el('h4',{},['Diesel (8 meters)']), ...state.diesel.map((m,i)=>el('div',{class:'row'},[el('div',{},['Meter '+(i+1)]),el('input',{class:'input',id:'d_open_'+i,placeholder:'Opening',value:m.open}),el('input',{class:'input',id:'d_close_'+i,placeholder:'Closing',value:m.close}),el('div',{},['Sold: '+(((parseFloat(m.close)||0)-(parseFloat(m.open)||0)).toFixed(2))]) ])), el('div',{style:'margin-top:12px'},[el('button',{class:'button',id:'saveMeters'},['Save Meters']),el('button',{class:'button',id:'toMenu',style:'margin-left:8px'},['Main Menu'])]) ]) ]); root.appendChild(header); root.appendChild(container); document.getElementById('toMenu').addEventListener('click',renderMainMenu); document.getElementById('saveMeters').addEventListener('click',()=>{ for(let i=0;i<4;i++){ state.petrol[i].open=document.getElementById('p_open_'+i).value; state.petrol[i].close=document.getElementById('p_close_'+i).value; } for(let i=0;i<8;i++){ state.diesel[i].open=document.getElementById('d_open_'+i).value; state.diesel[i].close=document.getElementById('d_close_'+i).value; } const dateVal=document.getElementById('dateInput').value; state.date=dateVal; saveDay(); alert('Meters saved'); }); }

function renderSalesEntry(){root.innerHTML=''; const header=el('div',{class:'header'},[el('div',{class:'logo-box'},['SFS']),el('div',{},[APP_NAME]),el('div',{},['Date: '+state.date]),el('button',{class:'button',id:'backBtn'},['Back'])]); const container=el('div',{class:'container'},[ el('div',{class:'card'},[ el('h3',{},['Sales Entry']), el('div',{class:'row'},[el('div',{},['Vehicle (required)']),el('input',{class:'input',id:'sale_vehicle'})]), el('div',{class:'row'},[el('div',{},['Name (optional)']),el('input',{class:'input',id:'sale_name'})]), el('div',{class:'row'},[el('div',{},['Type']), (function(){const s=el('select',{class:'input',id:'sale_type'});['Petrol','Diesel'].forEach(o=>s.appendChild(el('option',{},[o]))); return s; })()]), el('div',{class:'row'},[el('div',{},['Litres']),el('input',{class:'input',id:'sale_litres'})]), el('div',{class:'row'},[el('div',{},['Rate per litre']),el('input',{class:'input',id:'sale_rate'})]), el('div',{style:'margin-top:12px'},[el('button',{class:'button',id:'addSale'},['Add Sale']),el('button',{class:'button',id:'backMenu',style:'margin-left:8px'},['Main Menu'])]) ]) ]); root.appendChild(header); root.appendChild(container); document.getElementById('backMenu').addEventListener('click',renderMainMenu); document.getElementById('addSale').addEventListener('click',()=>{ const vehicle=document.getElementById('sale_vehicle').value.trim(); const name=document.getElementById('sale_name').value.trim(); const type=document.getElementById('sale_type').value; const litres=parseFloat(document.getElementById('sale_litres').value)||0; const rate=parseFloat(document.getElementById('sale_rate').value)||0; if(!vehicle) return alert('Vehicle number required'); const amount=+(litres*rate).toFixed(2); state.sales.push({vehicle,name,type,litres,rate,amount}); saveDay(); alert('Sale added'); }); }

function renderRecords(){root.innerHTML=''; const header=el('div',{class:'header'},[el('div',{class:'logo-box'},['SFS']),el('div',{},[APP_NAME]),el('div',{},['Date: '+state.date]),el('button',{class:'button',id:'backBtn'},['Back'])]); const container=el('div',{class:'container'},[ el('div',{class:'card'},[ el('h3',{},['Records / Reports']), el('div',{},['Petrol: '+calcLitres(state.petrol).toFixed(2)+' litres']), el('div',{},['Diesel: '+calcLitres(state.diesel).toFixed(2)+' litres']), el('div',{},['Total sales amount: '+state.sales.reduce((a,b)=>a+(b.amount||0),0).toFixed(2)]), el('h4',{},['Sales Today']), (function(){ const table=el('table',{class:'table'}); const thead=el('thead'); thead.appendChild(el('tr',{},[el('th',{},['Vehicle']),el('th',{},['Name']),el('th',{},['Type']),el('th',{},['Litres']),el('th',{},['Rate']),el('th',{},['Amount'])])); table.appendChild(thead); const tbody=el('tbody'); state.sales.forEach(s=>tbody.appendChild(el('tr',{},[el('td',{},[s.vehicle]),el('td',{},[s.name||'']),el('td',{},[s.type]),el('td',{},[String(s.litres)]),el('td',{},[String(s.rate)]),el('td',{},[String(s.amount)])]))); table.appendChild(tbody); return table; })(), el('div',{style:'margin-top:12px'},[el('button',{class:'button',id:'generateReport'},['Generate New Report']),el('button',{class:'button',id:'menuBtn',style:'margin-left:8px'},['Main Menu'])]) ]) ]); root.appendChild(header); root.appendChild(container); document.getElementById('menuBtn').addEventListener('click',renderMainMenu); document.getElementById('generateReport').addEventListener('click',generatePDF); }

if(state.loggedIn) renderMainMenu(); else renderLogin();
if('serviceWorker' in navigator){ navigator.serviceWorker.register('/service-worker.js').catch(()=>{}); }
window.generatePDF=generatePDF;
})();